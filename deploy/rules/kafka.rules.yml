groups:
- name: kafka
  rules:
  - alert: KafkaConsumerLagIncreasing
    expr: abs(delta(kafka_consumergroup_lag_sum[5m]) - avg_over_time(delta(kafka_consumergroup_lag_sum[5m])[1d:])) /
      stddev_over_time(delta(kafka_consumergroup_lag_sum[5m])[1d:]) > 1
    for: 15m
    labels:
      severity: warning
    annotations:
      description: abs(z-score) for lag of consumer group '{{$labels.consumergroup}}' is at {{$value | printf "%.3f"}} for '{{$labels.topic}}' topic
      summary: Consuming ratio of Kafka consumer group '{{$labels.consumergroup}}' is not enough for '{{$labels.topic}}' (abs(z-score > 1)

  - alert: KafkaConsumerTooHighLag
    expr: kafka_consumergroup_lag_sum > 1000000
    for: 1m
    labels:
      severity: critical
    annotations:
      description: Consumer group '{{$labels.consumergroup}}' has {{humanize $value}} pending messages from '{{$labels.topic}}' topic
      summary: Kafka consumers from '{{$labels.consumergroup}}' group are not consuming messages from '{{$labels.topic}}' (lag > 1M)
